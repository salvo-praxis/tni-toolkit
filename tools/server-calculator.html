<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNI Server Compatibility Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #0a0e14 0%, #1a1f2e 50%, #0d1117 100%);
            color: #c9d1d9;
            font-family: "JetBrains Mono", "Fira Code", "SF Mono", Consolas, monospace;
            padding: 24px;
        }
        
        .header {
            border-bottom: 1px solid #30363d;
            padding-bottom: 16px;
            margin-bottom: 24px;
        }
        
        .header h1 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #00ff88;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .header h1 span {
            color: #58a6ff;
        }
        
        .header p {
            margin: 8px 0 0;
            font-size: 12px;
            color: #8b949e;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
        }
        
        @media (max-width: 800px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
        
        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #58a6ff;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .list-container {
            background: rgba(22,27,34,0.8);
            border: 1px solid #30363d;
            border-radius: 6px;
            max-height: 280px;
            overflow-y: auto;
        }

        .list-container.programs {
            max-height: 325px;
        }
        
        .list-item {
            padding: 10px 12px;
            border-bottom: 1px solid #21262d;
            cursor: pointer;
            transition: background 0.15s;
        }
        
        .list-item:hover {
            background: rgba(88,166,255,0.08);
        }
        
        .list-item.selected {
            background: rgba(88,166,255,0.15);
        }
        
        .list-item.program-selected {
            background: rgba(0,255,136,0.1);
        }
        
        .list-item.program-selected:hover {
            background: rgba(0,255,136,0.15);
        }
        
        .list-item:not(.program-selected):hover {
            background: rgba(0,255,136,0.05);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .item-name {
            font-weight: 500;
            font-size: 12px;
            color: #c9d1d9;
        }
        
        .item-name.active {
            color: #58a6ff;
        }
        
        .item-name.program-active {
            color: #00ff88;
        }
        
        .item-price {
            color: #f0883e;
            font-size: 11px;
            font-weight: 600;
        }
        
        .item-stats {
            font-size: 10px;
            color: #8b949e;
            margin-top: 4px;
            display: flex;
            gap: 12px;
        }
        
        .program-meta {
            font-size: 10px;
            color: #8b949e;
        }
        
        .type-badge {
            padding: 2px 6px;
            border-radius: 3px;
            margin-right: 8px;
        }
        
        .type-producer { background: rgba(88,166,255,0.2); }
        .type-converter { background: rgba(240,136,62,0.2); }
        .type-storage { background: rgba(139,148,158,0.2); }
        .type-firmware { background: rgba(0,255,136,0.2); color: #00ff88; }
        
        .category-divider {
            padding: 6px 12px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid #30363d;
            font-size: 10px;
            color: #7d8590;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .item-output {
            font-size: 10px;
            color: #7d8590;
            margin-top: 4px;
        }
        
        .item-requires {
            color: #f0883e;
        }

        .file-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }
        .file-table th {
            text-align: left;
            color: #8b949e;
            font-weight: normal;
            padding: 2px 8px 2px 0;
            border-bottom: 1px solid #30363d;
        }
        .file-table th:not(:first-child) {
            text-align: center;
            width: 30px;
        }
        .file-table td {
            padding: 3px 8px 3px 0;
        }
        .file-table td:not(:first-child) {
            text-align: center;
            color: #8b949e;
        }

        .sata-toggle {
            margin-top: 12px;
            padding: 10px 12px;
            background: rgba(22,27,34,0.8);
            border: 1px solid #30363d;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 11px;
        }
        
        .sata-toggle input {
            accent-color: #58a6ff;
        }
        
        .sata-info {
            color: #8b949e;
        }

        .device-filter {
            margin-bottom: 12px;
        }

        .device-filter select {
            width: 100%;
            padding: 8px 12px;
            background: rgba(22,27,34,0.8);
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
        }

        .device-filter select:hover {
            border-color: #58a6ff;
        }

        .device-filter select:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .search-input {
            width: 100%;
            padding: 8px 12px;
            background: rgba(22,27,34,0.8);
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-family: inherit;
            font-size: 12px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .search-input:hover {
            border-color: #58a6ff;
        }

        .search-input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .search-input::placeholder {
            color: #8b949e;
        }

        /* Results Panel */
        .results {
            margin-top: 24px;
            border-radius: 8px;
            padding: 20px;
        }
        
        .results.valid {
            background: linear-gradient(135deg, rgba(0,255,136,0.05) 0%, rgba(22,27,34,0.9) 100%);
            border: 1px solid #238636;
        }
        
        .results.invalid {
            background: linear-gradient(135deg, rgba(255,68,68,0.05) 0%, rgba(22,27,34,0.9) 100%);
            border: 1px solid #f85149;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .results-title {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .results-title.valid { color: #00ff88; }
        .results-title.invalid { color: #ff4444; }
        
        .total-cost {
            font-size: 14px;
            font-weight: 700;
        }
        
        .cost-value { color: #f0883e; }
        .cost-sata { font-size: 11px; color: #8b949e; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }
        
        @media (max-width: 600px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .metric-box {
            border-radius: 6px;
            padding: 12px;
        }
        
        .metric-box.fits {
            background: rgba(0,255,136,0.1);
            border: 1px solid rgba(0,255,136,0.2);
        }
        
        .metric-box.over {
            background: rgba(255,68,68,0.1);
            border: 1px solid rgba(255,68,68,0.2);
        }
        
        .metric-label {
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 4px;
        }
        
        .metric-value {
            font-size: 20px;
            font-weight: 700;
        }
        
        .metric-value.fits { color: #00ff88; }
        .metric-value.over { color: #ff4444; }
        
        .metric-remaining {
            font-size: 10px;
            color: #8b949e;
            margin-top: 4px;
        }
        
        .metric-bar {
            margin-top: 8px;
            height: 4px;
            background: #21262d;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .metric-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s;
        }
        
        .metric-bar-fill.fits { background: #00ff88; }
        .metric-bar-fill.over { background: #ff4444; }
        
        .programs-summary {
            margin-top: 16px;
            font-size: 11px;
            color: #8b949e;
        }
        
        .programs-summary strong {
            color: #c9d1d9;
        }
        
        /* Footer */
        .footer {
            margin-top: 24px;
            padding: 12px;
            background: rgba(22,27,34,0.5);
            border: 1px solid #21262d;
            border-radius: 6px;
            font-size: 10px;
            color: #8b949e;
        }
        
        .footer strong {
            color: #58a6ff;
        }
        
        .hidden {
            display: none;
        }

        .sharecode-section {
            margin-top: 24px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .sharecode-section label {
            font-size: 11px;
            color: #8b949e;
        }

        .sharecode-input {
            flex: 1;
            min-width: 200px;
            padding: 6px 10px;
            background: rgba(22,27,34,0.8);
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-family: inherit;
            font-size: 11px;
        }

        .sharecode-input:hover {
            border-color: #58a6ff;
        }

        .sharecode-input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        .sharecode-section button {
            padding: 6px 12px;
            background: rgba(22,27,34,0.8);
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
        }

        .sharecode-section button:hover {
            border-color: #58a6ff;
            background: rgba(88,166,255,0.1);
        }

        .site-footer {
            margin-top: 40px;
            padding-top: 16px;
            border-top: 1px solid #30363d;
            text-align: center;
            font-size: 11px;
            color: #7d8590;
        }
        
        .site-footer a {
            color: #8b949e;
            text-decoration: none;
            transition: color 0.15s;
        }
        
        .site-footer a:hover {
            color: #58a6ff;
        }
        
        .site-footer .sep {
            margin: 0 8px;
            color: #30363d;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1><span>TNI</span> Server Compatibility Calculator</h1>
        <p>Tower Networking Inc. • Server-Program Resource Planning Tool</p>
    </div>

    <div class="grid">
        <!-- Device Selection -->
        <div>
            <h2 class="section-title">▸ Select Device</h2>
            <input type="text" class="search-input" id="device-search" placeholder="Search devices...">
            <div class="device-filter">
                <select id="device-type-filter">
                    <option value="all">All Devices</option>
                    <option value="servers">Servers</option>
                    <option value="network_switches">Switches</option>
                    <option value="routers">Routers</option>
                    <option value="firewalls_and_taps">Firewalls & TAPs</option>
                    <option value="debuggers_and_test_devices">Debuggers</option>
                </select>
            </div>
            <div class="list-container" id="device-list"></div>
            <div class="sata-toggle hidden" id="sata-toggle">
                <input type="checkbox" id="sata-checkbox" checked>
                <span>Auto-add SATA drives as needed</span>
                <span class="sata-info" id="sata-info"></span>
            </div>
        </div>

        <!-- Program Selection -->
        <div>
            <h2 class="section-title">▸ Select Programs</h2>
            <input type="text" class="search-input" id="program-search" placeholder="Search programs...">
            <div class="list-container programs" id="program-list"></div>
        </div>
    </div>

    <!-- Results Panel -->
    <div class="results hidden" id="results">
        <div class="results-header">
            <h2 class="results-title" id="results-title"></h2>
            <div class="total-cost" id="total-cost"></div>
        </div>
        <div class="metrics-grid" id="metrics-grid"></div>
        <div class="programs-summary hidden" id="programs-summary"></div>
    </div>

    <!-- Sharecode -->
    <div class="sharecode-section">
        <label>Sharecode:</label>
        <input type="text" id="sharecode" class="sharecode-input" placeholder="Paste sharecode to load...">
        <button id="copy-sharecode">Copy</button>
        <button id="copy-url">Copy URL</button>
    </div>

    <!-- Footer -->
    <div class="footer">
        <strong>Quick Reference:</strong>
        SATA Drive = +4 Storage @ $75 each •
        Converters need input resources from other programs
    </div>

    <script>
        // TNI Data - Device categories
        const devices = {
            servers: [
                { model: "MacroHard Boulder SRV", cpu: 4, memory: 4, storage: 6, sata_slots: 0, price: 540, power_w: 72, ports: 2 },
                { model: "MacroHard Boulder+ SRV", cpu: 6, memory: 8, storage: 8, sata_slots: 0, price: 1020, power_w: 161, ports: 2 },
                { model: "MacroHard Boulder+ SRV (Refurb)", cpu: 6, memory: 8, storage: 8, sata_slots: 0, price: 255, power_w: 161, ports: 2 },
                { model: "MacroHard Boulder++ SRV", cpu: 6, memory: 10, storage: 10, sata_slots: 0, price: 1750, power_w: 312, ports: 3 },
                { model: "MacroHard Monolith SRV", cpu: 16, memory: 10, storage: 4, sata_slots: 2, price: 2100, power_w: 429, ports: 2 },
                { model: "MacroHard Ledge Two SRV", cpu: 24, memory: 14, storage: 4, sata_slots: 2, price: 2625, power_w: 973, ports: 3 },
                { model: "MacroHard Ledge Three SRV", cpu: 24, memory: 16, storage: 4, sata_slots: 2, price: 4000, power_w: 1125, ports: 4 },
                { model: "MacroHard Megalith SRV", cpu: 32, memory: 16, storage: 4, sata_slots: 6, price: 4750, power_w: 1223, ports: 5 },
                { model: "Savannah Meerkat", cpu: 4, memory: 4, storage: 4, sata_slots: 0, price: 950, power_w: 62, ports: 2 },
                { model: "Savannah Gazelle", cpu: 6, memory: 6, storage: 6, sata_slots: 0, price: 2200, power_w: 108, ports: 2 },
                { model: "Savannah Aardvark", cpu: 10, memory: 10, storage: 5, sata_slots: 2, price: 4500, power_w: 293, ports: 3 },
                { model: "Savannah Wildebeest", cpu: 16, memory: 16, storage: 8, sata_slots: 2, price: 6800, power_w: 423, ports: 3 },
                { model: "MacroHard NLB2", cpu: 2, memory: 1, storage: 1, sata_slots: 0, price: 437, power_w: 83, ports: 3 },
                { model: "ICC1", cpu: 1, memory: 2, storage: 2, sata_slots: 1, price: 160, power_w: 19, ports: 1 },
                { model: "Golonys-Cinco", cpu: 1, memory: 1, storage: 1, sata_slots: 5, price: 400, power_w: 13, ports: 1 },
            ],
            network_switches: [
                { model: "Blade5", cpu: 2, memory: 1, storage: 1, firmware: "bladeos", price: 100, power_w: 22, ports: 5 },
                { model: "Blade10", cpu: 2, memory: 1, storage: 1, firmware: "bladeos", price: 450, power_w: 41, ports: 10 },
                { model: "Blade4", cpu: 2, memory: 1, storage: 1, firmware: "bladeos", price: 100, power_w: 30, ports: 4 },
                { model: "Blade12", cpu: 2, memory: 2, storage: 2, firmware: "vlanfirm", price: 1000, power_w: 84, ports: 12 },
                { model: "Blade66", cpu: 2, memory: 1, storage: 1, firmware: "bladeos", price: 950, power_w: 66, ports: 12 },
                { model: "Blade15", cpu: 2, memory: 2, storage: 2, firmware: "vlanfirm", price: 900, power_w: 88, ports: 15 },
                { model: "Blade88", cpu: 2, memory: 2, storage: 2, firmware: "vlanfirm", price: 1600, power_w: 87, ports: 16 },
                { model: "Blade88 (Refurb)", cpu: 2, memory: 2, storage: 2, firmware: "vlanfirm", price: 480, power_w: 87, ports: 16 },
                { model: "Blade30", cpu: 2, memory: 2, storage: 2, firmware: "vlanfirm", price: 1650, power_w: 183, ports: 30 },
                { model: "Blade1515", cpu: 2, memory: 2, storage: 2, firmware: "vlanfirm", price: 1850, power_w: 208, ports: 30 },
            ],
            routers: [
                { model: "Disco Nano", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 264, power_w: 21, ports: 5 },
                { model: "Disco Nano 2G", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 180, power_w: 23, ports: 4 },
                { model: "Disco Nano 3H", cpu: 8, memory: 2, storage: 4, firmware: "hakernel", price: 450, power_w: 26, ports: 4 },
                { model: "Disco Milli", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 325, power_w: 27, ports: 8 },
                { model: "Disco Milli 2G", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 500, power_w: 30, ports: 8 },
                { model: "Disco Milli 3G", cpu: 8, memory: 2, storage: 4, firmware: "hakernel", price: 800, power_w: 41, ports: 8 },
                { model: "Disco Milli 4G", cpu: 8, memory: 2, storage: 4, firmware: "hakernel", price: 1150, power_w: 60, ports: 8 },
                { model: "Disco Micro", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 600, power_w: 41, ports: 10 },
                { model: "Disco Micro 2G", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 950, power_w: 47, ports: 10 },
                { model: "Disco Micro 2G (Refurb)", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 285, power_w: 47, ports: 10 },
                { model: "Disco Micro 3G", cpu: 8, memory: 2, storage: 4, firmware: "hakernel", price: 1300, power_w: 50, ports: 10 },
                { model: "Zodianet Spine Router", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 1200, power_w: 78, ports: 3 },
                { model: "Zodianet Beam Router", cpu: 4, memory: 1, storage: 2, firmware: "rtkernel", price: 3700, power_w: 138, ports: 4 },
            ],
            firewalls_and_taps: [
                { model: "FireWatch ES4A", cpu: 4, memory: 1, storage: 2, firmware: "firewatcher", price: 550, power_w: 55, ports: 3 },
                { model: "FireWatch CP4E", cpu: 4, memory: 1, storage: 2, firmware: "firewatcher", price: 1500, power_w: 163, ports: 4 },
                { model: "EthTapper", cpu: 2, memory: 2, storage: 1, firmware: "wirerat", price: 300, power_w: 12, ports: 3 },
                { model: "Bastion 5E", cpu: 4, memory: 1, storage: 2, firmware: "firewatcher", price: 4000, power_w: 387, ports: 4 },
            ],
            debuggers_and_test_devices: [
                { model: "Debugger Alice", cpu: 1, memory: 1, storage: 1, firmware: "netpeeker", price: 1200, power_w: 72, ports: 2 },
                { model: "DNS Load Test Box", cpu: 1, memory: 1, storage: 1, firmware: "dnsspam", price: 0, power_w: 112, ports: 1 },
                { model: "DNS UDP/53 Load Tester", cpu: 1, memory: 1, storage: 1, firmware: "dnsspam", price: 1200, power_w: 202, ports: 1 },
            ],
        };

        const categoryLabels = {
            servers: "Servers",
            network_switches: "Switches",
            routers: "Routers",
            firewalls_and_taps: "Firewalls & TAPs",
            debuggers_and_test_devices: "Debuggers"
        };

        const programs = [
            { name: "dns-lite", type: "Producer", cpu: 1, memory: 1, storage: 2, output: "3 reply-dns-queries", requires: null },
            { name: "dns-server", type: "Converter", cpu: 4, memory: 3, storage: 3, output: "20 reply-dns-queries", requires: "1 store-text" },
            { name: "sun-dns", type: "Converter", cpu: 10, memory: 6, storage: 9, output: "40 reply-dns-queries", requires: "3 store-text" },
            { name: "padu_v1", type: "Producer", cpu: 1, memory: 2, storage: 4, output: "1 store-text, store-image", requires: null },
            { name: "padu_v2", type: "Producer", cpu: 2, memory: 4, storage: 8, output: "2 store-text/image/audio", requires: null },
            { name: "padu_v3", type: "Producer", cpu: 4, memory: 6, storage: 12, output: "4 store-text/image/audio/video", requires: null },
            { name: "poems-db", type: "Producer", cpu: 4, memory: 4, storage: 6, output: "4 store-text", requires: null },
            { name: "dnsmasq", type: "Producer", cpu: 1, memory: 1, storage: 2, output: "3 reply-dhcp-request", requires: null },
            { name: "kea", type: "Converter", cpu: 6, memory: 5, storage: 7, output: "15 reply-dhcp-request", requires: "1 store-text" },
            { name: "voip-server", type: "Producer", cpu: 5, memory: 2, storage: 5, output: "10 accept-voip-connection", requires: null },
            { name: "gitcoffee", type: "Converter", cpu: 4, memory: 2, storage: 4, output: "16 read-text, update-software", requires: "2 store-text" },
            { name: "mailer", type: "Converter", cpu: 5, memory: 6, storage: 3, output: "15 read/post-text, verify-user", requires: "3 store-text+image" },
            { name: "rtsp-diva-r", type: "Producer", cpu: 6, memory: 4, storage: 10, output: "13 accept-cctv-connection", requires: null },
            { name: "decentro-node", type: "Producer", cpu: 24, memory: 12, storage: 6, output: "10 facilitate-p2p-transaction", requires: null },
            { name: "decentro-wallet", type: "Storage", cpu: 1, memory: 2, storage: 2, output: "Stores p2p currency", requires: null },
            { name: "decentro-collector", type: "Converter", cpu: 1, memory: 1, storage: 1, output: "1 access-p2p-currency", requires: "1 access-p2p-currency" },
            { name: "ubbt", type: "Converter", cpu: 4, memory: 4, storage: 6, output: "4 support-bots", requires: "4 inspect-user-packets" },
            // Firmware (SFTP install)
            { name: "rtkernel", type: "Firmware", cpu: 4, memory: 1, storage: 2, output: "Router firmware", requires: "/etc/routes.conf" },
            { name: "hakernel", type: "Firmware", cpu: 8, memory: 2, storage: 4, output: "High-cap router firmware", requires: "/etc/routes.conf" },
            { name: "bladeos", type: "Firmware", cpu: 2, memory: 1, storage: 1, output: "Switch firmware", requires: null },
            { name: "vlanfirm", type: "Firmware", cpu: 2, memory: 2, storage: 2, output: "VLAN switch firmware", requires: "/etc/vlan.tags" },
            { name: "firewatcher", type: "Firmware", cpu: 4, memory: 1, storage: 2, output: "Firewall firmware", requires: "/etc/nftables.conf" },
            { name: "wirerat", type: "Firmware", cpu: 2, memory: 2, storage: 1, output: "4 inspect-user-packets", requires: null },
            { name: "netpeeker", type: "Firmware", cpu: 1, memory: 1, storage: 1, output: "Debugger firmware", requires: null },
            { name: "dnsspam", type: "Firmware", cpu: 1, memory: 1, storage: 1, output: "DNS blaster firmware", requires: null },
        ];

        const SATA_DRIVE_COST = 75;
        const SATA_DRIVE_STORAGE = 4;

        // State
        let selectedDevice = null;
        let selectedDeviceCategory = null;
        let selectedPrograms = [];
        let useSataExpansion = true;
        let currentFilter = 'all';
        let deviceSearch = '';
        let programSearch = '';

        // DOM Elements
        const deviceListEl = document.getElementById('device-list');
        const deviceFilterEl = document.getElementById('device-type-filter');
        const deviceSearchEl = document.getElementById('device-search');
        const programListEl = document.getElementById('program-list');
        const programSearchEl = document.getElementById('program-search');
        const sataToggleEl = document.getElementById('sata-toggle');
        const sataCheckboxEl = document.getElementById('sata-checkbox');
        const sataInfoEl = document.getElementById('sata-info');
        const resultsEl = document.getElementById('results');
        const resultsTitleEl = document.getElementById('results-title');
        const totalCostEl = document.getElementById('total-cost');
        const metricsGridEl = document.getElementById('metrics-grid');
        const programsSummaryEl = document.getElementById('programs-summary');
        const sharecodeEl = document.getElementById('sharecode');
        const copySharecodeBtn = document.getElementById('copy-sharecode');
        const copyUrlBtn = document.getElementById('copy-url');

        // Sharecode functions
        function generateSharecode() {
            const data = {
                d: selectedDevice ? selectedDevice.model : null,
                p: selectedPrograms.map(p => p.name),
                s: useSataExpansion
            };
            return btoa(JSON.stringify(data));
        }

        function loadSharecode(code) {
            try {
                const data = JSON.parse(atob(code));

                // Find device by model
                if (data.d) {
                    for (const [category, deviceList] of Object.entries(devices)) {
                        const device = deviceList.find(d => d.model === data.d);
                        if (device) {
                            selectedDevice = { ...device, _category: category };
                            selectedDeviceCategory = category;
                            break;
                        }
                    }
                } else {
                    selectedDevice = null;
                    selectedDeviceCategory = null;
                }

                // Find programs by name
                selectedPrograms = [];
                if (data.p && Array.isArray(data.p)) {
                    data.p.forEach(name => {
                        const program = programs.find(p => p.name === name);
                        if (program) selectedPrograms.push(program);
                    });
                }

                // Set SATA expansion
                useSataExpansion = data.s !== false;
                sataCheckboxEl.checked = useSataExpansion;

                // Update UI
                renderDevices();
                renderPrograms();
                updateToggles();
                calculate();
            } catch (e) {
                // Invalid sharecode, ignore
            }
        }

        function updateSharecode() {
            const code = generateSharecode();
            sharecodeEl.value = code;
            history.replaceState(null, '', '#' + code);
        }

        // Get filtered devices
        function getFilteredDevices() {
            let result = [];
            if (currentFilter === 'all') {
                for (const [category, deviceList] of Object.entries(devices)) {
                    deviceList.forEach(device => {
                        result.push({ ...device, _category: category });
                    });
                }
            } else {
                result = devices[currentFilter].map(d => ({ ...d, _category: currentFilter }));
            }
            // Apply search filter
            if (deviceSearch) {
                const search = deviceSearch.toLowerCase();
                result = result.filter(d => d.model.toLowerCase().includes(search));
            }
            return result;
        }

        // Render devices
        function renderDevices() {
            const filteredDevices = getFilteredDevices();

            deviceListEl.innerHTML = filteredDevices.map((device, idx) => {
                const isSelected = selectedDevice && selectedDevice.model === device.model && selectedDeviceCategory === device._category;
                const sataInfo = device.sata_slots > 0 ? ` +${device.sata_slots}SATA` : '';
                const firmwareInfo = device.firmware ? `FW:${device.firmware}` : '';

                return `
                    <div class="list-item ${isSelected ? 'selected' : ''}"
                         data-device-idx="${idx}">
                        <div class="item-header">
                            <span class="item-name ${isSelected ? 'active' : ''}">
                                ${device.model}
                            </span>
                            <span class="item-price">$${device.price}</span>
                        </div>
                        <div class="item-stats">
                            <span>C:${device.cpu}</span>
                            <span>M:${device.memory}</span>
                            <span>S:${device.storage}${sataInfo}</span>
                            <span>${device.power_w}W</span>
                            ${firmwareInfo ? `<span>${firmwareInfo}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers
            deviceListEl.querySelectorAll('.list-item').forEach(el => {
                el.addEventListener('click', () => {
                    const idx = parseInt(el.dataset.deviceIdx);
                    const device = filteredDevices[idx];
                    selectedDevice = device;
                    selectedDeviceCategory = device._category;
                    renderDevices();
                    updateToggles();
                    calculate();
                });
            });
        }

        // Get filtered programs
        function getFilteredPrograms() {
            if (!programSearch) return programs;
            const search = programSearch.toLowerCase();
            return programs.filter(p => p.name.toLowerCase().includes(search) || p.output.toLowerCase().includes(search));
        }

        // Render programs
        function renderPrograms() {
            const filteredPrograms = getFilteredPrograms();
            let html = '';
            let programsDividerAdded = false;
            let firmwareDividerAdded = false;

            filteredPrograms.forEach((program) => {
                const idx = programs.indexOf(program); // Get original index

                // Add dividers
                if (program.type !== 'Firmware' && !programsDividerAdded) {
                    html += '<div class="category-divider">Programs (program install)</div>';
                    programsDividerAdded = true;
                }
                if (program.type === 'Firmware' && !firmwareDividerAdded) {
                    html += `<div class="category-divider">Firmware (SFTP install)</div>`;
                    firmwareDividerAdded = true;
                }

                const isSelected = selectedPrograms.some(p => p.name === program.name);
                const typeClass = `type-${program.type.toLowerCase()}`;
                html += `
                    <div class="list-item ${isSelected ? 'program-selected' : ''}"
                         data-program-idx="${idx}">
                        <div class="item-header">
                            <span class="item-name ${isSelected ? 'program-active' : ''}">
                                ${isSelected ? '✓ ' : ''}${program.name}
                            </span>
                            <div class="program-meta">
                                <span class="type-badge ${typeClass}">${program.type}</span>
                                C:${program.cpu} M:${program.memory} S:${program.storage}
                            </div>
                        </div>
                        <div class="item-output">
                            → ${program.output}
                            ${program.requires ? `<span class="item-requires"> • needs: ${program.requires}</span>` : ''}
                        </div>
                    </div>
                `;
            });

            programListEl.innerHTML = html;

            // Add click handlers
            programListEl.querySelectorAll('.list-item').forEach(el => {
                el.addEventListener('click', () => {
                    const idx = parseInt(el.dataset.programIdx);
                    const program = programs[idx];
                    const existsIdx = selectedPrograms.findIndex(p => p.name === program.name);

                    if (existsIdx >= 0) {
                        selectedPrograms.splice(existsIdx, 1);
                    } else {
                        selectedPrograms.push(program);
                    }

                    renderPrograms();
                    calculate();
                });
            });
        }

        // Update SATA toggle visibility
        function updateToggles() {
            if (selectedDevice && selectedDevice.sata_slots > 0) {
                sataToggleEl.classList.remove('hidden');
                sataInfoEl.textContent = `(${selectedDevice.sata_slots} slots @ $${SATA_DRIVE_COST}/+${SATA_DRIVE_STORAGE} storage each)`;
            } else {
                sataToggleEl.classList.add('hidden');
            }
        }

        // Calculate and render results
        function calculate() {
            if (!selectedDevice) {
                resultsEl.classList.add('hidden');
                return;
            }

            const totalCpu = selectedPrograms.reduce((sum, p) => sum + p.cpu, 0);
            const totalMemory = selectedPrograms.reduce((sum, p) => sum + p.memory, 0);
            const totalStorage = selectedPrograms.reduce((sum, p) => sum + p.storage, 0);

            const sataSlots = selectedDevice.sata_slots || 0;
            const maxStorage = selectedDevice.storage + (sataSlots * SATA_DRIVE_STORAGE);
            const baseStorageDeficit = totalStorage - selectedDevice.storage;

            let sataNeeded = 0;
            let sataStorageProvided = 0;
            if (useSataExpansion && baseStorageDeficit > 0 && sataSlots > 0) {
                sataNeeded = Math.min(
                    Math.ceil(baseStorageDeficit / SATA_DRIVE_STORAGE),
                    sataSlots
                );
                sataStorageProvided = sataNeeded * SATA_DRIVE_STORAGE;
            }

            const effectiveStorage = selectedDevice.storage + sataStorageProvided;
            const sataCost = sataNeeded * SATA_DRIVE_COST;
            const totalCost = selectedDevice.price + sataCost;

            const cpuFits = totalCpu <= selectedDevice.cpu;
            const memoryFits = totalMemory <= selectedDevice.memory;
            const storageFits = totalStorage <= effectiveStorage;
            const allFit = cpuFits && memoryFits && storageFits;

            const cpuRemaining = selectedDevice.cpu - totalCpu;
            const memoryRemaining = selectedDevice.memory - totalMemory;
            const storageRemaining = effectiveStorage - totalStorage;

            // Update results panel
            resultsEl.classList.remove('hidden', 'valid', 'invalid');
            resultsEl.classList.add(allFit ? 'valid' : 'invalid');

            resultsTitleEl.className = `results-title ${allFit ? 'valid' : 'invalid'}`;
            resultsTitleEl.textContent = allFit ? '✓ CONFIGURATION VALID' : '✗ INSUFFICIENT RESOURCES';

            totalCostEl.innerHTML = `Total Cost: <span class="cost-value">$${totalCost}</span>` +
                (sataCost > 0 ? ` <span class="cost-sata">(incl. $${sataCost} SATA)</span>` : '');

            // Render metrics
            metricsGridEl.innerHTML = `
                ${renderMetric('CPU LOAD', totalCpu, selectedDevice.cpu, cpuFits, cpuRemaining, '')}
                ${renderMetric('MEMORY', totalMemory, selectedDevice.memory, memoryFits, memoryRemaining, '')}
                ${renderMetric(
                    'STORAGE' + (sataNeeded > 0 ? ` (+${sataNeeded} SATA)` : ''),
                    totalStorage,
                    effectiveStorage,
                    storageFits,
                    storageRemaining,
                    !storageFits ? ` (max: ${maxStorage})` : ''
                )}
            `;

            // Programs summary with file table
            if (selectedPrograms.length > 0) {
                // Build file list
                const files = [];
                selectedPrograms.forEach(p => {
                    const hasConfig = p.requires && p.requires.startsWith('/etc/');
                    // Config storage is included in program's storage requirement
                    const binStorage = hasConfig ? p.storage - 1 : p.storage;
                    files.push({ path: `/bin/${p.name}`, cpu: p.cpu, mem: p.memory, storage: binStorage });
                    if (hasConfig) {
                        files.push({ path: p.requires, cpu: '-', mem: '-', storage: 1 });
                    }
                });
                // Sort alphabetically by path
                files.sort((a, b) => a.path.localeCompare(b.path));

                const rows = files.map(f =>
                    `<tr><td>${f.path}</td><td>${f.cpu}</td><td>${f.mem}</td><td>${f.storage}</td></tr>`
                ).join('');

                programsSummaryEl.classList.remove('hidden');
                programsSummaryEl.innerHTML = `
                    <strong>Programs:</strong> ${selectedPrograms.map(p => p.name).join(' + ')}
                    <table class="file-table">
                        <thead><tr><th>File</th><th>C</th><th>M</th><th>S</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>`;
            } else {
                programsSummaryEl.classList.add('hidden');
            }

            // Update sharecode
            updateSharecode();
        }

        function renderMetric(label, used, total, fits, remaining, extra) {
            const pct = Math.min(100, (used / total) * 100);
            const statusClass = fits ? 'fits' : 'over';
            const remainingText = fits
                ? `${remaining} remaining`
                : `${Math.abs(remaining)} over capacity${extra}`;

            return `
                <div class="metric-box ${statusClass}">
                    <div class="metric-label">${label}</div>
                    <div class="metric-value ${statusClass}">${used} / ${total}</div>
                    <div class="metric-remaining">${remainingText}</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill ${statusClass}" style="width: ${pct}%"></div>
                    </div>
                </div>
            `;
        }

        // Filter change handler
        deviceFilterEl.addEventListener('change', (e) => {
            currentFilter = e.target.value;
            // Clear selection if device not in new filter
            if (selectedDevice && currentFilter !== 'all' && selectedDeviceCategory !== currentFilter) {
                selectedDevice = null;
                selectedDeviceCategory = null;
                updateToggles();
            }
            renderDevices();
            calculate();
        });

        // SATA checkbox handler
        sataCheckboxEl.addEventListener('change', (e) => {
            useSataExpansion = e.target.checked;
            calculate();
        });

        // Device search handler
        deviceSearchEl.addEventListener('input', (e) => {
            deviceSearch = e.target.value;
            renderDevices();
        });

        // Program search handler
        programSearchEl.addEventListener('input', (e) => {
            programSearch = e.target.value;
            renderPrograms();
        });

        // Sharecode input handler
        sharecodeEl.addEventListener('input', (e) => {
            const code = e.target.value.trim();
            if (code) loadSharecode(code);
        });

        // Copy sharecode button
        copySharecodeBtn.addEventListener('click', () => {
            sharecodeEl.select();
            navigator.clipboard.writeText(sharecodeEl.value);
        });

        // Copy URL button
        copyUrlBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(window.location.href);
        });

        // Handle URL hash changes (browser back/forward)
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash) loadSharecode(hash);
        });

        // Initialize
        renderDevices();
        renderPrograms();

        // Load from URL hash if present
        if (window.location.hash) {
            loadSharecode(window.location.hash.slice(1));
        }
    </script>

    <div class="site-footer">
        <a href="https://github.com/salvo-praxis/tni-toolkit" target="_blank">TNI Toolkit</a>
        <span class="sep">|</span>
        <a href="https://store.steampowered.com/app/2939600/Tower_Networking_Inc/" target="_blank">Tower Networking Inc. on Steam</a>
    </div>
</body>
</html>
