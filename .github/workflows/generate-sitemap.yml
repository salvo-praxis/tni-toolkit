# ============================================================================
# TNI Toolkit - GitHub Actions Workflow
# File: .github/workflows/generate-sitemap.yml
# Name: Generate Sitemap
# Version: 1.0.1
# Updated: 2025-12-15
# Part of: TNI Toolkit (https://github.com/salvo-praxis/tni-toolkit)
# Description:
#   Auto-generates sitemap.xml on every push to main branch.
#   Uses cicirello/generate-sitemap to crawl HTML and JSON files,
#   then commits the updated sitemap back to the repository.
# Contributors:
#   - salvo-praxis (@salvo-praxis) - workflow design
#   - Claude - YAML scaffolding
# Changelog:
#   1.0.1 - Fixed sync step: temp copy approach for handling concurrent pushes
#   1.0.0 - Initial release
# ============================================================================

name: Generate Sitemap

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest
    
    steps:
      # ----------------------------------------------------------
      # Step 1: Check out repository with full history
      # (required for accurate lastmod dates)
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ----------------------------------------------------------
      # Step 2: Generate sitemap.xml
      # ----------------------------------------------------------
      - name: Generate sitemap
        id: sitemap
        uses: cicirello/generate-sitemap@v1
        with:
          base-url-path: https://tni-toolkit.salvo.host/
          include-pdf: false
          additional-extensions: json
      
      # ----------------------------------------------------------
      # Step 3: Output sitemap stats
      # ----------------------------------------------------------
      - name: Sitemap stats
        run: |
          echo "Sitemap generated with ${{ steps.sitemap.outputs.sitemap-url-count }} URLs"
          echo "Excluded ${{ steps.sitemap.outputs.excluded-count }} URLs"
      
      # ----------------------------------------------------------
      # Step 4: Sync with origin before commit (handle concurrent pushes)
      # ----------------------------------------------------------
      - name: Sync with latest origin/main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Save our generated sitemap
          cp sitemap.xml /tmp/sitemap.xml
          # Reset to whatever origin has now
          git fetch origin main
          git reset --hard origin/main
          # Restore our generated sitemap
          cp /tmp/sitemap.xml sitemap.xml
      
      # ----------------------------------------------------------
      # Step 5: Commit updated sitemap
      # ----------------------------------------------------------
      - name: Commit sitemap
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "seo: auto-update sitemap.xml"
          file_pattern: "sitemap.xml"
