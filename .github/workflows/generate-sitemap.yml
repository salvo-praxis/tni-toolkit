# ============================================================================
# TNI Toolkit - GitHub Actions Workflow
# File: .github/workflows/generate-sitemap.yml
# Name: Generate Sitemap
# Version: 1.2.1
# Updated: 2025-12-17
# Part of: TNI Toolkit (https://github.com/salvo-praxis/tni-toolkit)
#
# Description:
#   Auto-generates sitemap.xml on every push to main branch. First step in
#   the deployment chain:
#   Generate Sitemap → Generate OG Images → Build ZIP & Deploy Repo To FTP
#   (Archive workflows run separately on schedule/manual trigger)
#
# Exclusions (via post-processing):
#   - Search engine verification files (google*.html, BingSiteAuth.xml)
#   - MD files (not included - no additional-extensions entry)
#
# Additions (via post-processing):
#   - tni-toolkit.zip (for archive.org to capture)
#
# Contributors:
#   - salvo-praxis (@salvo-praxis) - workflow design
#   - Claude - YAML scaffolding
#
# Changelog:
#   1.2.1 - Fixed YAML parse error: replaced f-string with .replace() for date insertion
#   1.2.0 - Added tni-toolkit.zip to sitemap (for archive.org)
#   1.1.1 - Fixed exclusion: use sed post-processing instead of invalid parameter
#   1.1.0 - Added exclusion pattern for verification files (broken)
#   1.0.1 - Fixed sync step: temp copy approach for handling concurrent pushes
#   1.0.0 - Initial release
# ============================================================================

name: Generate Sitemap

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  generate-sitemap:
    runs-on: ubuntu-latest
    
    steps:
      # ----------------------------------------------------------
      # Step 1: Check out repository with full history
      # (required for accurate lastmod dates)
      # ----------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # ----------------------------------------------------------
      # Step 2: Generate sitemap.xml
      # ----------------------------------------------------------
      - name: Generate sitemap
        id: sitemap
        uses: cicirello/generate-sitemap@v1
        with:
          base-url-path: https://tni-toolkit.salvo.host/
          include-pdf: false
          additional-extensions: json
      
      # ----------------------------------------------------------
      # Step 3: Clean sitemap and add tni-toolkit.zip
      # (remove verification files, images; add zip for archive.org)
      # ----------------------------------------------------------
      - name: Clean and enhance sitemap
        run: |
          python3 << 'EOF'
          import re
          from datetime import datetime
          
          with open('sitemap.xml', 'r') as f:
              content = f.read()
          
          # Pattern to match full <url>...</url> blocks containing unwanted files
          exclusion_patterns = [
              r'<url>\s*<loc>[^<]*google[a-z0-9]*\.html[^<]*</loc>\s*<lastmod>[^<]*</lastmod>\s*</url>\s*',
              r'<url>\s*<loc>[^<]*BingSiteAuth\.xml[^<]*</loc>\s*<lastmod>[^<]*</lastmod>\s*</url>\s*',
              r'<url>\s*<loc>[^<]*/images/[^<]*</loc>\s*<lastmod>[^<]*</lastmod>\s*</url>\s*',
          ]
          
          for pattern in exclusion_patterns:
              content = re.sub(pattern, '', content)
          
          today = datetime.now().strftime('%Y-%m-%d')
          
          # Add tni-toolkit.zip for archive.org to capture
          zip_block = '''  <url>
    <loc>https://tni-toolkit.salvo.host/tni-toolkit.zip</loc>
    <lastmod>DATE_PLACEHOLDER</lastmod>
  </url>
'''.replace('DATE_PLACEHOLDER', today)
          
          # Insert before </urlset>
          content = content.replace('</urlset>', zip_block + '</urlset>')
          
          with open('sitemap.xml', 'w') as f:
              f.write(content)
          
          print("Sitemap cleaned; tni-toolkit.zip added for archive.org")
          EOF
      
      # ----------------------------------------------------------
      # Step 4: Output sitemap stats
      # ----------------------------------------------------------
      - name: Sitemap stats
        run: |
          echo "Sitemap generated with ${{ steps.sitemap.outputs.sitemap-url-count }} URLs (before cleaning)"
          echo "Final URL count: $(grep -c '<loc>' sitemap.xml)"
          echo "Zip file included: $(grep -c 'tni-toolkit.zip' sitemap.xml)"
      
      # ----------------------------------------------------------
      # Step 5: Sync with origin before commit (handle concurrent pushes)
      # ----------------------------------------------------------
      - name: Sync with latest origin/main
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # Save our generated sitemap
          cp sitemap.xml /tmp/sitemap.xml
          # Reset to whatever origin has now
          git fetch origin main
          git reset --hard origin/main
          # Restore our generated sitemap
          cp /tmp/sitemap.xml sitemap.xml
      
      # ----------------------------------------------------------
      # Step 6: Commit updated sitemap
      # ----------------------------------------------------------
      - name: Commit sitemap
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "seo: auto-update sitemap.xml"
          file_pattern: "sitemap.xml"
