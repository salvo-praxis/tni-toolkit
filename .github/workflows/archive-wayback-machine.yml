# ============================================================================
# TNI Toolkit - GitHub Actions Workflow
# File: .github/workflows/archive-wayback-machine.yml
# Name: Submit To Wayback Machine
# Version: 1.1.1
# Updated: 2025-12-16
# Part of: TNI Toolkit (https://github.com/salvo-praxis/tni-toolkit)
# Description:
#   Archives all sitemap URLs to Archive.org's Wayback Machine.
#   Runs daily at midnight UTC and can be triggered manually.
#   Separate from the deploy chain to avoid submitting every small change.
# 
# Required Secrets:
#   ARCHIVE_ORG_S3_ACCESS_KEY - Your Archive.org S3 access key
#   ARCHIVE_ORG_S3_SECRET_KEY - Your Archive.org S3 secret key
#   (Get keys at: https://archive.org/account/s3.php)
#
# Contributors:
#   - salvo-praxis (@salvo-praxis) - workflow design
#   - Claude - YAML scaffolding
# Changelog:
#   1.1.1 - Changed schedule from weekly to daily
#   1.1.0 - Changed to scheduled (weekly) + manual; removed auto-trigger
#   1.0.1 - Updated description to reflect chain (with OG images step)
#   1.0.0 - Initial release
# ============================================================================

name: Submit To Wayback Machine

on:
  # Daily schedule: midnight UTC
  schedule:
    - cron: '0 0 * * *'
  
  # Allow manual trigger
  workflow_dispatch: {}

jobs:
  archive:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------
      # Step 1: Set up Python
      # ----------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # ----------------------------------------------------------
      # Step 2: Install wayback-machine-archiver
      # ----------------------------------------------------------
      - name: Install archiver
        run: pip install wayback-machine-archiver

      # ----------------------------------------------------------
      # Step 3: Archive all sitemap URLs
      # ----------------------------------------------------------
      - name: Archive sitemap URLs
        env:
          INTERNET_ARCHIVE_ACCESS_KEY: ${{ secrets.ARCHIVE_ORG_S3_ACCESS_KEY }}
          INTERNET_ARCHIVE_SECRET_KEY: ${{ secrets.ARCHIVE_ORG_S3_SECRET_KEY }}
        run: |
          echo "Archiving all URLs from sitemap..."
          archiver --sitemaps https://tni-toolkit.salvo.host/sitemap.xml
          echo "Archive request submitted successfully!"

      # ----------------------------------------------------------
      # Step 4: Summary
      # ----------------------------------------------------------
      - name: Summary
        run: |
          echo "## Wayback Machine Archive" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Archive request submitted for all sitemap URLs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View archives at: https://web.archive.org/web/*/https://tni-toolkit.salvo.host/*" >> $GITHUB_STEP_SUMMARY
