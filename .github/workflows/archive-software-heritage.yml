# ============================================================================
# TNI Toolkit - GitHub Actions Workflow
# File: .github/workflows/archive-software-heritage.yml
# Name: Archive to Software Heritage
# Version: 1.0.0
# Updated: 2025-12-15
# Part of: TNI Toolkit (https://github.com/salvo-praxis/tni-toolkit)
# Description:
#   Triggers Software Heritage archive on every release publication.
#   Submits a "Save Code Now" request to preserve the repository state.
#   Also runs on manual workflow dispatch for ad-hoc archiving.
# Contributors:
#   - salvo-praxis (@salvo-praxis) - workflow design
#   - Claude - YAML scaffolding
# Changelog:
#   1.0.0 - Initial release
# ============================================================================

name: Archive to Software Heritage

on:
  release:
    types: [ published ]
  workflow_dispatch: {}

jobs:
  archive:
    runs-on: ubuntu-latest
    
    steps:
      # ----------------------------------------------------------
      # Step 1: Trigger Software Heritage Save Code Now
      # ----------------------------------------------------------
      - name: Archive to Software Heritage
        run: |
          echo "Triggering Software Heritage archive for: ${{ github.repository }}"
          
          # Submit save request via Software Heritage API
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://archive.softwareheritage.org/api/1/origin/save/git/url/https://github.com/${{ github.repository }}/")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response code: $HTTP_CODE"
          echo "Response body: $BODY"
          
          # Check for success (200, 201, or 202)
          if [[ "$HTTP_CODE" =~ ^2[0-9][0-9]$ ]]; then
            echo "‚úÖ Archive request submitted successfully"
          else
            echo "‚ö†Ô∏è Archive request may have failed (code: $HTTP_CODE)"
            echo "This is often okay - the repo may already be queued or recently archived"
          fi
      
      # ----------------------------------------------------------
      # Step 2: Output archive link
      # ----------------------------------------------------------
      - name: Output archive link
        run: |
          echo "üì¶ View archived repository at:"
          echo "https://archive.softwareheritage.org/browse/origin/?origin_url=https://github.com/${{ github.repository }}"
